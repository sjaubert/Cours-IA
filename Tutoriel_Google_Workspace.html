<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutoriel : Gemini CLI + gas-fakes</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 900px;
            margin: auto;
            background-color: #fdfdfd;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        h1 {
            font-size: 2.4em;
            text-align: center;
            border: none;
            color: #34495e;
        }
        h2 {
            font-size: 2em;
            margin-top: 40px;
        }
        h3 {
            font-size: 1.6em;
            margin-top: 30px;
            border-bottom: 1px solid #ddd;
        }
        
        /* --- Styles pour les blocs de code --- */
        .code-container {
            position: relative;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .code-header {
            background-color: #333;
            color: white;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .code-header::after {
            /* Instruction visuelle pour la copie */
            content: 'Sélectionnez et copiez (Ctrl+C)';
            font-style: italic;
            color: #bbb;
            font-size: 0.9em;
        }
        pre {
            background-color: #282c34; /* Thème sombre */
            color: #abb2bf; /* Couleur de texte claire */
            padding: 15px;
            border-radius: 0 0 5px 5px;
            overflow-x: auto;
            margin-top: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 1em;
        }
        code {
            font-family: inherit;
        }
        /* --- Fin des styles de code --- */

        ul {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
        
        /* --- Blocs pédagogiques --- */
        .motivation, .analogy, .warning {
            padding: 15px 20px;
            margin: 25px 0;
            border-radius: 5px;
            border-left: 5px solid;
        }
        .motivation {
            background-color: #e6f7ff;
            border-color: #007bff;
        }
        .analogy {
            background-color: #e6f3e6;
            border-color: #28a745;
        }
        .warning {
            background-color: #fffbe6;
            border-color: #faad14;
        }
        
        img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>

    <h1>Tutoriel : Exécuter l'IA (Gemini) sur vos fichiers Google Workspace en toute sécurité</h1>

    <div class="motivation">
        <h3>◉ La Motivation (Le "Pourquoi ?")</h3>
        <p>Avez-vous déjà rêvé de dire à une IA : <i>"Ajoute le préfixe '[Pour Revue]' à tous les Google Docs dans ce dossier"</i> ?</p>
        <p>Le problème est simple : pour faire cela, l'IA (comme Gemini) a besoin d'accéder à votre Google Drive. Mais les permissions standards (comme <code>.../auth/drive</code>) sont un "pass-partout". Elles donnent à l'IA un accès total à <strong>tous</strong> vos fichiers, ce qui pose un risque de sécurité majeur.</p>
        <p>Ce tutoriel vous montre comment créer un "bac à sable" (sandbox) sécurisé. L'IA pourra exécuter des scripts, mais vous ne lui donnerez la permission que pour <strong>des fichiers spécifiques</strong>, un par un.</p>
    </div>

    <div class="analogy">
        <h3>◉ L'Analogie : L'Assistant Stagiaire</h3>
        <ul>
            <li><strong>Le Problème (Sans ce tutoriel) :</strong> Vous engagez un stagiaire (l'IA Gemini) et vous lui donnez un pass-partout qui ouvre <strong>toutes</strong> les portes de l'entreprise, y compris le bureau du PDG et le coffre-fort. C'est risqué.</li>
            <li><strong>La Solution (Avec ce tutoriel) :</strong> Vous placez le stagiaire (IA Gemini) dans une pièce sécurisée (le "fake-sandbox"). Pour chaque dossier ou document dont il a besoin, il doit vous faire une demande spécifique. Vous lui donnez alors une clé qui n'ouvre que cette <strong>seule et unique porte</strong> (le "whitelist" d'ID de fichier). L'assistant est efficace, mais la sécurité est totale.</li>
        </ul>
    </div>

    <h2>Prérequis</h2>
    <p>Avant de commencer, assurez-vous d'avoir les éléments suivants :</p>
    <ul>
        <li><strong>Node.js et npm :</strong> Installés sur votre machine.</li>
        <li><strong>Gemini CLI :</strong> L'outil d'IA en ligne de commande de Google.</li>
        <li><strong>Un projet Google Cloud (GCP) :</strong> Avec les bonnes authentifications (voir Étape 1).</li>
    </ul>

    <h2>Plan d'Action : L'Installation en 5 Étapes</h2>

    <h3>Étape 1 : Installer et configurer <code>gas-fakes</code></h3>
    
    <div class="warning">
        <strong>Attention :</strong> C'est l'étape la plus complexe, celle qui faisait l'objet de notre discussion précédente. Ce tutoriel suppose que vous avez <strong>déjà réussi</strong> à :
        <ol>
            <li>Créer un projet Google Cloud (GCP).</li>
            <li>Créé des identifiants OAuth ("Application de bureau").</li>
            <li>Configuré l'écran de consentement (en mode "Externe" avec vous-même comme "Test user").</li>
            <li>Téléchargé les scripts <code>shells</code> de <code>gas-fakes</code>.</li>
            <li>Exécuté <code>bash setaccount.sh</code> et <code>bash enable.sh</code> avec succès.</li>
        </ol>
        Si ce n'est pas fait, ce tutoriel ne fonctionnera pas.
    </div>
    
    <p>Créez un dossier pour ce projet (ex: <code>gemini-sandbox</code>) et installez <code>gas-fakes</code> :</p>

    <div class="code-container">
        <div class="code-header">Terminal (bash)</div>
        <pre><code>mkdir gemini-sandbox
cd gemini-sandbox
npm install @mcpher/gas-fakes</code></pre>
    </div>

    <h3>Étape 2 : Installer le serveur MCP</h3>
    <p>Pour que Gemini (l'IA) puisse "parler" à notre bac à sable (<code>gas-fakes</code>), nous avons besoin d'un traducteur : le serveur MCP (Model Context Protocol). Installez les modules nécessaires :</p>
    
    <div class="code-container">
        <div class="code-header">Terminal (bash)</div>
        <pre><code>npm install @modelcontextprotocol/sdk zod</code></pre>
    </div>

    <h3>Étape 3 : Créer le script du serveur (<code>gas-fakes-mcp.js</code>)</h3>
    <p>C'est le cœur de notre système. Créez un fichier nommé <code>gas-fakes-mcp.js</code> à la racine de votre dossier <code>gemini-sandbox</code> et collez-y le code suivant.</p>
    <p>Ce script définit l'outil <code>run_gas_with_gas-fakes</code> que Gemini pourra appeler. Notez les commentaires que j'ai traduits :</p>

    <div class="code-container">
        <div class="code-header">gas-fakes-mcp.js</div>
        <pre><code>import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import { exec } from "child_process";
import fs from "fs/promises";
import { setTimeout } from "node:timers/promises";
import { promisify } from "util";
import { z } from "zod";

const server = new McpServer({
  name: "Serveur MCP pour gas-fakes",
  version: "0.0.1",
});

const execAsync = promisify(exec);

const tool = {
  name: "run_gas_with_gas-fakes",
  schema: {
    description:
      "Utilisez ceci pour exécuter de manière sécurisée un script Google Apps Script dans un bac à sable (sandbox) en utilisant gas-fakes.",
    inputSchema: {
      gas_script: z
        .string()
        .describe(
          `Fournir un script Google Apps Script. C'est le script généré par l'IA. 
           Si le script est dans une fonction (ex: function sample() { ... }), il faut ajouter sample(); à la fin pour l'exécuter.
           IMPORTANT : gas-fakes ne supporte pas Logger.log(). Utilisez console.log() à la place.
           En cas d'erreur, l'IA devra modifier le script en se basant sur l'erreur.`
        ),
      whitelistItems: z
        .array(z.string().describe(`ID de fichier sur Google Drive`))
        .describe(
          `Utilisez ceci pour accéder à des fichiers EXISTANTS sur Google Drive. 
           Fournissez les ID des fichiers (ex: un ID de Google Sheet) dans un tableau. 
           L'option "sandbox" doit être à true (ce qui est le défaut).`
        )
        .optional(),
      sandbox: z
        .boolean()
        .describe(
          `Le défaut est 'true' (recommandé). Quand 'true', le script est exécuté dans le bac à sable sécurisé. 
           Quand 'false', le script s'exécute sans le bac à sable (moins sécurisé).`
        ),
    },
  },
  func: async (object = {}) => {
    const { sandbox = true, whitelistItems = [], gas_script } = object;
    const importFile = "./sample_gas.mjs"; // Fichier temporaire

    function getImportScript() {
      const importScriptAr = [
        `import "./node_modules/@mcpher/gas-fakes/main.js"`,
        "",
      ];
      if (whitelistItems.length === 0) {
        // Mode "Sandbox" standard (création de fichiers autorisée)
        importScriptAr.push(
          sandbox ? `ScriptApp.__behavior.sandBoxMode = true;` : "",
          `\n\n${gas_script}\n\n`,
          // Nettoie les fichiers créés après l'exécution
          sandbox ? `ScriptApp.__behavior.trash();` : ""
        );
      } else {
        // Mode "Sandbox STICT" (accès à des fichiers spécifiques)
        const wl = whitelistItems
          .map((id) => `behavior.newIdWhitelistItem("${id}").setWrite(true)`)
          .join(",");
        importScriptAr.push(
          `const behavior = ScriptApp.__behavior;`,
          `behavior.sandboxMode = true;`, // Active le bac à sable
          `behavior.strictSandbox = true;`, // Active le mode strict (rien n'est autorisé sauf la whitelist)
          `behavior.setIdWhitelist([${wl}]);`, // Applique la liste blanche
          `\n\n${gas_script}\n\n`,
          `ScriptApp.__behavior.trash();` // Nettoie (ex: si un nouveau fichier a été créé)
        );
      }
      return importScriptAr.join("\n");
    }

    try {
      // 1. Écrit le script de l'IA dans un fichier temporaire
      const importScript = getImportScript();
      await fs.writeFile(importFile, importScript);
      await setTimeout(500); // Laisse le temps au fichier d'être écrit

      // 2. Exécute le fichier temporaire avec Node.js
      const { stdout } = await execAsync(`node ./${importFile}`);
      return {
        content: [{ type: "text", text: stdout || "Terminé." }],
        isError: false,
      };
    } catch (err) {
      // 3. Renvoie une erreur si l'exécution échoue
      return {
        content: [{ type: "text", text: err.message }],
        isError: true,
      };
    } finally {
      // 4. Supprime toujours le fichier temporaire
      try {
        await fs.unlink(importFile);
      } catch (err) {
        console.error(err.message);
      }
    }
  },
};

const { name, schema, func } = tool;
server.registerTool(name, schema, func);

const transport = new StdioServerTransport();
await server.connect(transport);
</code></pre>
    </div>

    <h3>Étape 4 : Installer le Gemini CLI</h3>
    <p>Si ce n'est pas déjà fait, installez le Gemini CLI en suivant les instructions sur le <a href="https://github.com/google/gemini-cli" target="_blank">dépôt officiel Gemini CLI</a>.</p>

    <h3>Étape 5 : Configurer le Gemini CLI</h3>
    <p>Nous devons dire à Gemini où trouver notre "traducteur" (le serveur MCP). Localisez votre dossier <code>.gemini</code> (souvent dans votre dossier utilisateur) et modifiez le fichier <code>settings.json</code>.</p>
    <p>Ajoutez la section <code>mcpServers</code> :</p>
    
    <div class="code-container">
        <div class="code-header">.gemini/settings.json</div>
        <pre><code>{
  "security": {
    "auth": {
      "selectedType": "### votre réglage actuel ###"
    }
  },
  "ui": {
    "theme": "Default"
  },
  "mcpServers": {
    "gas-fakes": {
      "command": "node",
      "args": ["/chemin/absolu/vers/votre/projet/gemini-sandbox/gas-fakes-mcp.js"]
    }
  }
}
</code></pre>
    </div>
    
    <div class="warning">
        <strong>Important :</strong> Vous devez remplacer <code>/chemin/absolu/vers/votre/projet/gemini-sandbox/gas-fakes-mcp.js</code> par le chemin complet sur votre disque dur (ex: <code>C:\\Utilisateurs\\Stephane\\projets\\gemini-sandbox\\gas-fakes-mcp.js</code> ou <code>/home/stephane/projets/gemini-sandbox/gas-fakes-mcp.js</code>).
    </div>

    <h3>Étape 6 : Vérifier la structure</h3>
    <p>Votre dossier <code>gemini-sandbox</code> devrait ressembler à ceci (en plus des fichiers de l'Étape 1 comme <code>.env</code>, <code>gasfakes.json</code>, etc.) :</p>
    
    <pre><code>/gemini-sandbox/
├── .env                  (de l'étape 1)
├── gas-fakes-mcp.js      (créé à l'étape 3)
├── gasfakes.json         (de l'étape 1)
├── package-lock.json
├── package.json
└── node_modules/
</code></pre>


    <h2>◉ Apprentissage par Simulation : La Démonstration</h2>
    <p>Ouvrez un nouveau terminal et lancez Gemini :</p>
    
    <div class="code-container">
        <div class="code-header">Terminal (bash)</div>
        <pre><code>gemini</code></pre>
    </div>

    <h3>Exemple 1 : Créer un script (Sandbox Standard)</h3>
    <p>Cet exemple demande à l'IA de créer un script de A à Z. Le sandbox l'autorisera à créer un nouveau fichier, puis le nettoiera.</p>
    
    <p><strong>Prompt (ce que vous tapez) :</strong></p>
    <pre><code>Suis la mission suivante dans l'ordre.

## 1. Crée un script Google Apps Script
Crée un script GAS pour réaliser les étapes suivantes. N'exécute pas le script, montre-le moi d'abord.
1. Crée un nouveau Google Spreadsheet nommé "feuille de calcul temporaire".
2. Insère une nouvelle feuille nommée "temp" dans ce Spreadsheet.
3. Insère les valeurs [["header1", "header2"], ["a2", "b2"]] dans la feuille "temp".
4. Récupère les valeurs de la ligne 2.
5. Affiche ces valeurs avec console.log().

## 2. Exécute le script
Maintenant, exécute le script que tu viens de créer.
    </code></pre>

    <p><strong>Résultat (ce que l'IA va faire) :</strong></p>
    <p>Gemini va d'abord vous montrer le code. Puis, il détectera qu'il a l'outil <code>run_gas_with_gas-fakes</code>. Il appellera cet outil avec le script qu'il a généré. Vous verrez (dans votre Google Drive) le fichier se créer puis être mis à la corbeille, et le terminal affichera le résultat de <code>console.log()</code>.</p>


    <h3>Exemple 2 : Interagir avec un fichier existant (Sandbox Sécurisé)</h3>
    <p>C'est l'exemple le plus important. Nous avons un Google Sheet qui existe déjà (disons avec l'ID <code>"ID_DE_VOTRE_FEUILLE"</code>).</p>

    <p><strong>Prompt (ce que vous tapez) :</strong></p>
    <pre><code>Suis la mission suivante dans l'ordre.

## 1. Crée un script Google Apps Script
Crée un script GAS pour réaliser les étapes suivantes. N'exécute pas le script.
1. Ouvre le Spreadsheet existant par son ID : "ID_DE_VOTRE_FEUILLE".
2. Récupère toutes les valeurs de la feuille nommée "Sheet1".
3. Affiche ces valeurs avec console.log().

## 2. Exécute le script
Maintenant, exécute ce script en utilisant le mode sandbox et en ajoutant "ID_DE_VOTRE_FEUILLE" à la liste blanche (whitelist).
    </code></pre>

    <p><strong>Résultat (ce que l'IA va faire) :</strong></p>
    <p>L'IA va générer le script. Ensuite, elle appellera l'outil <code>run_gas_with_gas-fakes</code> en passant deux arguments :</p>
    <ol>
        <li><code>gas_script</code>: Le script pour lire la feuille.</li>
        <li><code>whitelistItems</code>: <code>["ID_DE_VOTRE_FEUILLE"]</code></li>
    </ol>
    <p>Notre serveur MCP (Étape 3) va voir cette "whitelist". Il va configurer <code>gas-fakes</code> en mode "strict", n'autorisant l'accès qu'à cet ID de fichier. Le script s'exécutera et affichera les données de votre feuille en toute sécurité.</p>
    
    <div class="warning">
        <strong>Que se passe-t-il si l'IA triche ?</strong>
        <p>Si l'IA génère un script qui essaie de lire un <i>autre</i> fichier (dont l'ID n'est pas dans la whitelist), le sandbox <code>gas-fakes</code> le bloquera et renverra une erreur de permission. C'est le cœur de la sécurité !</p>
    </div>

    <h3>Exemple 3 : Gérer les limitations</h3>
    <p><code>gas-fakes</code> n'implémente pas 100% d'Apps Script (par exemple, les graphiques). Cet exemple montre comment l'IA réagit.</p>

    <p><strong>Prompt (ce que vous tapez) :</strong></p>
    <pre><code>Crée un script qui insère des données dans une feuille, puis crée un graphique à partir de ces données. Exécute-le.</code></pre>
    
    <p><strong>Résultat (ce que l'IA va faire) :</strong></p>
    <ol>
        <li>L'IA génère un script avec <code>.newChart()</code>.</li>
        <li>Elle l'exécute via notre outil.</li>
        <li><code>gas-fakes</code> va renvoyer une erreur (ex: <code>Erreur: .newChart() n'est pas une fonction implémentée</code>).</li>
        <li>Le serveur MCP renvoie cette erreur à Gemini.</li>
        <li>Gemini va (normalement) vous répondre : <i>"Désolé, la première tentative a échoué avec l'erreur '...newChart() n'est pas une fonction...'. Je vais modifier le script pour supprimer l'étape du graphique."</i></li>
    </ol>


    <h2>Conclusion : Votre assistant IA sécurisé</h2>
    <p>En intégrant <code>gas-fakes</code> comme un serveur MCP, vous transformez Gemini CLI en un puissant assistant d'automatisation, tout en gardant le contrôle total de votre sécurité.</p>

    <ul>
        <li><strong>Sécurité Améliorée :</strong> Par défaut, les scripts s'exécutent dans un bac à sable, les empêchant d'accéder à vos fichiers sans permission explicite.</li>
        <li><strong>Permissions Granulaires :</strong> Vous pouvez autoriser l'accès fichier par fichier (whitelist) pour les tâches spécifiques.</li>
        <li><strong>Automatisation Conversationnelle :</strong> Vous pouvez maintenant automatiser des tâches complexes en langage naturel, sans écrire de code vous-même.</li>
        <li><strong>Flexibilité :</strong> Vous gardez la possibilité de désactiver le sandbox (<code>sandbox: false</code>) pour des opérations que vous jugez sûres.</li>
    </ul>

</body>
</html>